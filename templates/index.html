<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¼ì§„ì–´ë¬µ ë¼ë²¨ ë§ˆìŠ¤í„° V2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f4f7f6; font-family: 'Pretendard', sans-serif; }
        .main-container { max-width: 800px; margin: 30px auto; }
        .step-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 30px; border: none; }
        .step-title { font-weight: 800; color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; }
        .step-badge { background: #e55525; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; margin-right: 10px; }
        .upload-box { border: 2px dashed #cbd5e0; border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; transition: 0.3s; background: #f8fafc; }
        .upload-box:hover { border-color: #e55525; background: #fff5f0; }
        .btn-action { background: #2c3e50; color: white; padding: 12px 0; width: 100%; border-radius: 10px; font-weight: bold; margin-top: 15px; transition: 0.2s; }
        .btn-action:hover { background: #1a252f; }
        .btn-action:disabled { background: #bdc3c7; }
        #loadingOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 9999; text-align: center; padding-top: 20%; }
        .issue-critical { border-left: 5px solid #e74c3c; background: #fdedec; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        .issue-minor { border-left: 5px solid #f1c40f; background: #fef9e7; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        .issue-law { border-left: 5px solid #8e44ad; background: #f4ecf7; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        .law-status-compliant { color: #27ae60; font-weight: bold; }
        .law-status-violation { color: #e74c3c; font-weight: bold; }
        .law-status-review { color: #f39c12; font-weight: bold; }
    </style>
</head>
<body>

<div class="main-container">
    <h2 class="text-center mb-5" style="color: #e55525; font-weight: 900;">ğŸŸ ì‚¼ì§„ì–´ë¬µ ì‹í’ˆí‘œì‹œì‚¬í•­ ì™„ì„± í”Œë«í¼</h2>

    <div class="step-card">
        <div class="step-title"><span class="step-badge">STEP 0</span> QA ìë£Œ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)</div>
        
        <div class="mb-3">
            <label class="form-label fw-bold">QA ìë£Œ íŒŒì¼ë“¤ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>
            <input type="file" id="qaFiles" class="form-control" accept=".xlsx,.xls,.pdf,image/*" multiple>
            <div class="form-text">ì—‘ì…€, PDF, ì´ë¯¸ì§€ ë“± QA ê´€ë ¨ ìë£Œë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.</div>
        </div>
        
        <button class="btn btn-action" onclick="uploadQA()">QA ìë£Œë¡œ ì‹í’ˆí‘œì‹œì‚¬í•­ ì‘ì„±í•˜ê¸°</button>
        
        <div id="qaResult" class="mt-3 p-3 bg-light rounded" style="display:none;">
            <h6 class="fw-bold text-success">âœ… ì‹í’ˆí‘œì‹œì‚¬í•­ ì‘ì„± ì™„ë£Œ!</h6>
            <div style="font-size: 0.85rem; color: #555;">
                <strong>ì œí’ˆëª…:</strong> <span id="qaProductName"></span><br>
                <strong>ì‘ì„±ëœ í‘œì‹œì‚¬í•­:</strong><br>
                <div id="qaLabelText" class="p-2 bg-white border rounded mt-1"></div>
                <div id="qaLawCompliance" class="mt-2"></div>
            </div>
        </div>
    </div>

    <div class="step-card">
        <div class="step-title"><span class="step-badge">STEP 1</span> ê¸°ì¤€ ë°ì´í„° ìƒì„± (BOM + ì›ì¬ë£Œ)</div>

        <div class="mb-3">
            <label class="form-label fw-bold">1. í’ˆëª©ì œì¡°ë³´ê³ ì„œ/ë°°í•©ë¹„ (Excel)</label>
            <input type="file" id="excelFile" class="form-control" accept=".xlsx, .xls">
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">2. ì›ì¬ë£Œ í‘œì‹œì‚¬í•­ ì‚¬ì§„ë“¤ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>
            <input type="file" id="rawFiles" class="form-control" accept="image/*" multiple>
            <div class="form-text">Ctrl í‚¤ë¥¼ ëˆ„ë¥´ê³  ì—¬ëŸ¬ ì¥ì„ í•œ ë²ˆì— ì„ íƒí•˜ì„¸ìš”. (ì˜ˆ: ë‹¹ê·¼, ì—°ìœ¡, ì†ŒìŠ¤ ë“±)</div>
        </div>

        <button class="btn btn-action" onclick="createStandard()">ê¸°ì¤€ ë°ì´í„° ìƒì„±í•˜ê¸°</button>

        <div id="standardResult" class="mt-3 p-3 bg-light rounded" style="display:none;">
            <h6 class="fw-bold text-success">âœ… ê¸°ì¤€ ìƒì„± ì™„ë£Œ!</h6>
            <div id="labelContent" style="font-size: 0.9rem; color: #333;">
                <!-- ì œí’ˆ ì •ë³´ í‘œ -->
                <div id="productInfoTable" class="mb-3"></div>
                
                <!-- ì›ì¬ë£Œëª… -->
                <div id="ingredientsSection" class="mb-3"></div>
                
                <!-- ì•Œë ˆë¥´ê¸° ì •ë³´ -->
                <div id="allergensSection" class="mb-3"></div>
                
                <!-- ì˜ì–‘ì •ë³´ -->
                <div id="nutritionSection" class="mb-3"></div>
                
                <!-- ì œì¡°ì› ì •ë³´ -->
                <div id="manufacturerSection" class="mb-3"></div>
                
                <!-- ì£¼ì˜ì‚¬í•­ -->
                <div id="precautionsSection" class="mb-3"></div>
                
                <!-- ë²•ë¥  ì¤€ìˆ˜ ìƒíƒœ -->
                <div id="lawCompliance" class="mt-2"></div>
            </div>
        </div>
    </div>

    <div class="step-card">
        <div class="step-title"><span class="step-badge">STEP 2</span> ë””ìì¸ ê²€ì¦ (ìµœì¢… ì™„ì„±ë³¸)</div>

        <div class="mb-3">
            <label class="form-label fw-bold">1. ê¸°ì¤€ ë°ì´í„° ì—‘ì…€ íŒŒì¼ (ìˆ˜ì • ê°€ëŠ¥)</label>
            <input type="file" id="standardExcelFile" class="form-control" accept=".xlsx,.xls" onchange="checkVerifyButton()">
            <div class="form-text">STEP 1ì—ì„œ ë‹¤ìš´ë¡œë“œí•œ ì—‘ì…€ íŒŒì¼ì„ ìˆ˜ì • í›„ ì—…ë¡œë“œí•˜ê±°ë‚˜, ìƒˆë¡œ ìƒì„±ëœ ê¸°ì¤€ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</div>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">2. ë””ìì¸ ì™„ì„±ë³¸ (PDF ë˜ëŠ” ì´ë¯¸ì§€)</label>
            <input type="file" id="designFile" class="form-control" accept=".pdf, image/*" onchange="checkVerifyButton()">
        </div>

        <button id="btnVerify" class="btn btn-action" onclick="verifyDesign()" disabled>ê²€ì¦ ì‹œì‘</button>
    </div>

        <div id="ocrHighlightCard" class="step-card" style="display:none;">
        <div class="step-title">ğŸ” AI ì •ë°€ ë¶„ì„ ê²°ê³¼ (í•˜ì´ë¼ì´íŠ¸)</div>
        <p class="text-muted small mb-2">
            * ë¶‰ì€ìƒ‰ìœ¼ë¡œ í‘œì‹œëœ ë¶€ë¶„ì€ ê¸°ì¤€ ì •ë³´ì™€ ë‹¤ë¥´ê±°ë‚˜ ì˜¤íƒ€ê°€ ì˜ì‹¬ë˜ëŠ” ê³³ì…ë‹ˆë‹¤.<br>
            * ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì •ë‹µ(Expected)ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
                <!-- í•˜ì´ë¼ì´íŠ¸ ëœ í…ìŠ¤íŠ¸ê°€ ë“¤ì–´ê°ˆ ìƒì -->
        <div id="ocr-highlight-view" class="ocr-text-box" style="
            min-height: 150px;
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Pretendard', sans-serif;
            line-height: 1.8;
        ">
            ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
        </div>
    </div>
    
    <div id="reportArea" class="step-card" style="display:none;">
        <div class="step-title">ğŸ“Š ê²€ì¦ ê²°ê³¼ ë¦¬í¬íŠ¸</div>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>ì ìˆ˜: <span id="scoreBadge" class="badge bg-primary"></span></h4>
        </div>
        <div id="lawComplianceReport" class="mb-3"></div>
        <div id="issueList"></div>
    </div>
</div>

<div id="loadingOverlay">
    <div class="spinner-border text-danger" style="width: 4rem; height: 4rem;" role="status"></div>
    <h3 class="mt-4 fw-bold" style="color: #2c3e50;">AIê°€ ìë£Œë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</h3>
    <p class="text-muted">ì—‘ì…€ê³¼ ì—¬ëŸ¬ ì¥ì˜ ì‚¬ì§„ì„ ì²˜ë¦¬í•˜ëŠë¼ ì‹œê°„ì´ ì¡°ê¸ˆ ê±¸ë¦½ë‹ˆë‹¤.</p>
</div>

<script>
    let standardData = null;

    async function uploadQA() {
        const qaFiles = document.getElementById('qaFiles').files;
        
        if (qaFiles.length === 0) return alert("QA ìë£Œ íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì„¸ìš”!");
        
        const formData = new FormData();
        for (let i = 0; i < qaFiles.length; i++) {
            formData.append('qa_files', qaFiles[i]);
        }
        
        document.getElementById('loadingOverlay').style.display = 'block';
        
        try {
            const res = await fetch('/api/upload-qa', { method: 'POST', body: formData });
            const data = await res.json();
            
            if (data.error) throw new Error(data.error);
            
            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('qaResult').style.display = 'block';
            document.getElementById('qaProductName').innerText = data.product_name || 'N/A';
            document.getElementById('qaLabelText').innerText = data.label_text || 'N/A';
            
            // ë²•ë¥  ì¤€ìˆ˜ ìƒíƒœ í‘œì‹œ
            const lawComplianceDiv = document.getElementById('qaLawCompliance');
            if (data.law_compliance) {
                const status = data.law_compliance.status;
                let statusText = '';
                let statusClass = '';
                if (status === 'compliant') {
                    statusText = 'âœ… ë²•ë¥  ì¤€ìˆ˜';
                    statusClass = 'law-status-compliant';
                } else if (status === 'needs_review') {
                    statusText = 'âš ï¸ ë²•ë¥  ê²€í†  í•„ìš”';
                    statusClass = 'law-status-review';
                }
                
                let html = `<div class="${statusClass}">${statusText}</div>`;
                if (data.law_compliance.issues && data.law_compliance.issues.length > 0) {
                    html += '<ul class="mt-2">';
                    data.law_compliance.issues.forEach(issue => {
                        html += `<li>${issue}</li>`;
                    });
                    html += '</ul>';
                }
                lawComplianceDiv.innerHTML = html;
            }
            
        } catch (e) {
            alert("ì˜¤ë¥˜: " + e.message);
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }

    async function createStandard() {
        const excelFile = document.getElementById('excelFile').files[0];
        const rawFiles = document.getElementById('rawFiles').files;

        if (!excelFile) return alert("ë°°í•©ë¹„ ì—‘ì…€ íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì„¸ìš”!");
        if (rawFiles.length === 0) return alert("ì›ì¬ë£Œ ì‚¬ì§„ì„ ì ì–´ë„ 1ì¥ ì´ìƒ ì˜¬ë ¤ì£¼ì„¸ìš”!");

        const formData = new FormData();
        formData.append('excel_file', excelFile);
        for (let i = 0; i < rawFiles.length; i++) {
            formData.append('raw_images', rawFiles[i]);
        }

        document.getElementById('loadingOverlay').style.display = 'block';

        try {
            const res = await fetch('/api/create-standard', { method: 'POST', body: formData });
            const data = await res.json();

            if (data.error) throw new Error(data.error);

            standardData = JSON.stringify(data);

            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('standardResult').style.display = 'block';
            
            // ì œí’ˆ ì •ë³´ í‘œ
            if (data.product_info) {
                const info = data.product_info;
                let html = '<h6 class="fw-bold mb-2">ğŸ“‹ ì œí’ˆ ì •ë³´</h6>';
                html += '<table class="table table-bordered table-sm">';
                html += `<tr><th style="width: 30%; background: #f8f9fa;">ì œí’ˆëª…</th><td>${info.product_name || '-'}</td></tr>`;
                html += `<tr><th style="background: #f8f9fa;">ì‹í’ˆì˜ ìœ í˜•</th><td>${info.food_type || '-'}</td></tr>`;
                html += `<tr><th style="background: #f8f9fa;">ë‚´ìš©ëŸ‰</th><td>${info.net_weight || '-'}</td></tr>`;
                html += `<tr><th style="background: #f8f9fa;">ì†Œë¹„ê¸°í•œ</th><td>${info.expiration_date || '-'}</td></tr>`;
                html += `<tr><th style="background: #f8f9fa;">ë³´ê´€ë°©ë²•</th><td>${info.storage_method || '-'}</td></tr>`;
                html += `<tr><th style="background: #f8f9fa;">í¬ì¥ì¬ì§ˆ</th><td>${info.packaging_material || '-'}</td></tr>`;
                html += `<tr><th style="background: #f8f9fa;">í’ˆëª©ë³´ê³ ë²ˆí˜¸</th><td>${info.item_report_number || '-'}</td></tr>`;
                if (info.front_calories) {
                    html += `<tr><th style="background: #f8f9fa;">ì „ë©´ë¶€ ì´ì—´ëŸ‰/ë¬¸êµ¬</th><td>${info.front_calories}</td></tr>`;
                }
                html += '</table>';
                document.getElementById('productInfoTable').innerHTML = html;
            } else {
                // ê¸°ì¡´ í˜•ì‹ í˜¸í™˜ì„±
                document.getElementById('productInfoTable').innerHTML = 
                    `<h6 class="fw-bold mb-2">ğŸ“‹ ì œí’ˆëª…: ${data.product_name || '-'}</h6>`;
            }
            
            // ì›ì¬ë£Œëª…
            if (data.ingredients) {
                let html = '<h6 class="fw-bold mb-2">ğŸ¥˜ ì›ì¬ë£Œëª…</h6>';
                if (data.ingredients.structured_list && data.ingredients.structured_list.length > 0) {
                    html += '<div class="mb-2"><strong>êµ¬ì¡°í™”ëœ ë¦¬ìŠ¤íŠ¸:</strong><ul class="mb-0">';
                    data.ingredients.structured_list.forEach(item => {
                        html += `<li>${item}</li>`;
                    });
                    html += '</ul></div>';
                }
                if (data.ingredients.continuous_text) {
                    html += `<div class="p-2 bg-white border rounded"><strong>ì—°ì† í…ìŠ¤íŠ¸:</strong><br>${data.ingredients.continuous_text}</div>`;
                }
                document.getElementById('ingredientsSection').innerHTML = html;
            } else if (data.final_label_text) {
                // ê¸°ì¡´ í˜•ì‹ í˜¸í™˜ì„±
                document.getElementById('ingredientsSection').innerHTML = 
                    `<h6 class="fw-bold mb-2">ğŸ¥˜ ì›ì¬ë£Œëª…</h6><div class="p-2 bg-white border rounded">${data.final_label_text}</div>`;
            }
            
            // ì•Œë ˆë¥´ê¸° ì •ë³´
            if (data.allergens) {
                let html = '<h6 class="fw-bold mb-2">âš ï¸ ì•Œë ˆë¥´ê¸° ì •ë³´</h6>';
                if (data.allergens.contains && data.allergens.contains.length > 0) {
                    html += `<div class="mb-2"><strong>í•¨ìœ :</strong> ${data.allergens.contains.join(', ')}</div>`;
                }
                if (data.allergens.manufacturing_facility) {
                    html += `<div class="p-2 bg-white border rounded"><small>${data.allergens.manufacturing_facility}</small></div>`;
                }
                document.getElementById('allergensSection').innerHTML = html;
            } else if (data.allergens && Array.isArray(data.allergens)) {
                // ê¸°ì¡´ í˜•ì‹ í˜¸í™˜ì„±
                document.getElementById('allergensSection').innerHTML = 
                    `<h6 class="fw-bold mb-2">âš ï¸ ì•Œë ˆë¥´ê¸° ì •ë³´</h6><div>${data.allergens.join(', ')}</div>`;
            }
            
            // ì˜ì–‘ì •ë³´
            if (data.nutrition_info) {
                let html = '<h6 class="fw-bold mb-2">ğŸ“Š ì˜ì–‘ì •ë³´</h6>';
                html += '<table class="table table-bordered table-sm">';
                html += '<thead class="table-dark"><tr><th>ì˜ì–‘ì„±ë¶„</th><th>100g ë‹¹</th><th>1ì¼ ì˜ì–‘ì„±ë¶„ ê¸°ì¤€ì¹˜ì— ëŒ€í•œ ë¹„ìœ¨(%)</th></tr></thead>';
                html += '<tbody>';
                
                const nut = data.nutrition_info.per_100g;
                if (nut.calories) {
                    html += `<tr><th>ì´ ì—´ëŸ‰</th><td>${nut.calories}</td><td>-</td></tr>`;
                }
                if (nut.sodium) {
                    html += `<tr><td>ë‚˜íŠ¸ë¥¨</td><td>${nut.sodium.amount}</td><td>${nut.sodium.daily_value}</td></tr>`;
                }
                if (nut.fat) {
                    html += `<tr><td>ì§€ë°©</td><td>${nut.fat.amount}</td><td>${nut.fat.daily_value}</td></tr>`;
                }
                if (nut.cholesterol) {
                    html += `<tr><td>ì½œë ˆìŠ¤í…Œë¡¤</td><td>${nut.cholesterol.amount}</td><td>${nut.cholesterol.daily_value}</td></tr>`;
                }
                if (nut.carbohydrates) {
                    html += `<tr><td>íƒ„ìˆ˜í™”ë¬¼</td><td>${nut.carbohydrates.amount}</td><td>${nut.carbohydrates.daily_value}</td></tr>`;
                }
                if (nut.sugars) {
                    html += `<tr><td>ë‹¹ë¥˜</td><td>${nut.sugars.amount}</td><td>${nut.sugars.daily_value}</td></tr>`;
                }
                if (nut.trans_fat) {
                    html += `<tr><td>íŠ¸ëœìŠ¤ì§€ë°©</td><td>${nut.trans_fat.amount}</td><td>${nut.trans_fat.daily_value}</td></tr>`;
                }
                if (nut.saturated_fat) {
                    html += `<tr><td>í¬í™”ì§€ë°©</td><td>${nut.saturated_fat.amount}</td><td>${nut.saturated_fat.daily_value}</td></tr>`;
                }
                if (nut.protein) {
                    html += `<tr><td>ë‹¨ë°±ì§ˆ</td><td>${nut.protein.amount}</td><td>${nut.protein.daily_value}</td></tr>`;
                }
                
                html += '</tbody></table>';
                if (data.nutrition_info.total_content) {
                    html += `<div class="mt-2"><small><strong>ì´ ë‚´ìš©ëŸ‰:</strong> ${data.nutrition_info.total_content}</small></div>`;
                }
                if (data.nutrition_info.disclaimer) {
                    html += `<div class="mt-2"><small class="text-muted">${data.nutrition_info.disclaimer}</small></div>`;
                }
                document.getElementById('nutritionSection').innerHTML = html;
            }
            
            // ì œì¡°ì› ì •ë³´
            if (data.manufacturer) {
                let html = '<h6 class="fw-bold mb-2">ğŸ­ ì œì¡°ì› / ì†Œì¬ì§€</h6>';
                html += `<div>${data.manufacturer.name || ''} / ${data.manufacturer.address || ''}</div>`;
                document.getElementById('manufacturerSection').innerHTML = html;
            }
            
            // ì£¼ì˜ì‚¬í•­
            if (data.precautions && data.precautions.length > 0) {
                let html = '<h6 class="fw-bold mb-2">âš ï¸ ì£¼ì˜ì‚¬í•­</h6><ul>';
                data.precautions.forEach(item => {
                    html += `<li>${item}</li>`;
                });
                html += '</ul>';
                document.getElementById('precautionsSection').innerHTML = html;
            }

            // ë²•ë¥  ì¤€ìˆ˜ ìƒíƒœ í‘œì‹œ
            const lawComplianceDiv = document.getElementById('lawCompliance');
            if (data.law_compliance) {
                const status = data.law_compliance.status;
                let statusText = '';
                let statusClass = '';
                if (status === 'compliant') {
                    statusText = 'âœ… ë²•ë¥  ì¤€ìˆ˜';
                    statusClass = 'law-status-compliant';
                } else if (status === 'needs_review') {
                    statusText = 'âš ï¸ ë²•ë¥  ê²€í†  í•„ìš”';
                    statusClass = 'law-status-review';
                } else {
                    statusText = 'âŒ ë²•ë¥  ìœ„ë°˜';
                    statusClass = 'law-status-violation';
                }
                
                let html = `<div class="${statusClass} p-2 rounded">${statusText}</div>`;
                if (data.law_compliance.issues && data.law_compliance.issues.length > 0) {
                    html += '<ul class="mt-2">';
                    data.law_compliance.issues.forEach(issue => {
                        html += `<li>${issue}</li>`;
                    });
                    html += '</ul>';
                }
                lawComplianceDiv.innerHTML = html;
            }

            // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'btn btn-success mt-2';
            downloadBtn.innerHTML = 'ğŸ“¥ ê¸°ì¤€ ë°ì´í„° ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ';
            downloadBtn.onclick = () => downloadStandardExcel(data);
            document.getElementById('standardResult').appendChild(downloadBtn);

            // 2ë‹¨ê³„ëŠ” ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆìŒ (disabled ì†ì„± ì œê±°ë¨)
            checkVerifyButton();

        } catch (e) {
            alert("ì˜¤ë¥˜: " + e.message);
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }

    async function downloadStandardExcel(data) {
        try {
            const res = await fetch('/api/download-standard-excel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.error || 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
            }
            
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${data.product_info?.product_name || data.product_name || 'ê¸°ì¤€ë°ì´í„°'}_ê¸°ì¤€ë°ì´í„°.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            alert('ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        } catch (e) {
            alert("ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜: " + e.message);
        }
    }

    function checkVerifyButton() {
        // ë””ìì¸ íŒŒì¼ì€ í•„ìˆ˜, ê¸°ì¤€ ë°ì´í„°ëŠ” ì—‘ì…€ íŒŒì¼ ë˜ëŠ” STEP 1 ë°ì´í„° ì¤‘ í•˜ë‚˜ë§Œ ìˆìœ¼ë©´ ë¨
        const designFile = document.getElementById('designFile').files[0];
        const standardExcelFile = document.getElementById('standardExcelFile').files[0];
        
        if (designFile && (standardExcelFile || standardData)) {
            document.getElementById('btnVerify').disabled = false;
        } else {
            document.getElementById('btnVerify').disabled = true;
        }
    }

    async function verifyDesign() {
        const designFile = document.getElementById('designFile').files[0];
        const standardExcelFile = document.getElementById('standardExcelFile').files[0];
        
        if (!designFile) return alert("ë””ìì¸ íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì„¸ìš”!");
        if (!standardExcelFile && !standardData) {
            return alert("ê¸°ì¤€ ë°ì´í„° ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜, STEP 1ì„ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”!");
        }

        const formData = new FormData();
        formData.append('design_file', designFile);
        
        // ì—‘ì…€ íŒŒì¼ì´ ìˆìœ¼ë©´ ì—‘ì…€ íŒŒì¼ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ JSON ë°ì´í„° ì‚¬ìš©
        if (standardExcelFile) {
            formData.append('standard_excel', standardExcelFile);
        } else if (standardData) {
            formData.append('standard_data', standardData);
        }

        document.getElementById('loadingOverlay').style.display = 'block';

        try {
            const res = await fetch('/api/verify-design', { method: 'POST', body: formData });
            const data = await res.json();

            if (data.error) throw new Error(data.error);

            displayReport(data);

        } catch (e) {
            alert("ì˜¤ë¥˜: " + e.message);
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }

    function displayReport(data) {
        document.getElementById('reportArea').style.display = 'block';
        document.getElementById('scoreBadge').innerText = data.score + "ì ";

        // ë²•ë¥  ì¤€ìˆ˜ ìƒíƒœ í‘œì‹œ
        const lawComplianceDiv = document.getElementById('lawComplianceReport');
        if (data.law_compliance) {
            const status = data.law_compliance.status;
            let statusText = '';
            let statusClass = '';
            if (status === 'compliant') {
                statusText = 'âœ… ë²•ë¥  ì¤€ìˆ˜';
                statusClass = 'law-status-compliant';
            } else if (status === 'violation') {
                statusText = 'âŒ ë²•ë¥  ìœ„ë°˜ ë°œê²¬';
                statusClass = 'law-status-violation';
            }
            
            let html = `<div class="p-3 bg-light rounded mb-3"><strong>ë²•ë¥  ì¤€ìˆ˜ ìƒíƒœ:</strong> <span class="${statusClass}">${statusText}</span></div>`;
            if (data.law_compliance.violations && data.law_compliance.violations.length > 0) {
                html += '<div class="p-3 bg-light rounded mb-3"><strong>ë²•ë¥  ìœ„ë°˜ ì‚¬í•­:</strong><ul class="mt-2">';
                data.law_compliance.violations.forEach(violation => {
                    html += `<li>${violation}</li>`;
                });
                html += '</ul></div>';
            }
            lawComplianceDiv.innerHTML = html;
        }

        const list = document.getElementById('issueList');
        list.innerHTML = "";

                    // [ì¶”ê°€] í•˜ì´ë¼ì´íŠ¸ ë°•ìŠ¤ ì¼œê¸° ë° ë‚´ìš© ì±„ìš°ê¸°
        // [ê°•ë ¥ ìˆ˜ì •] í•˜ì´ë¼ì´íŠ¸ ë°•ìŠ¤ ê°•ì œ í‘œì‹œ
    const ocrCard = document.getElementById('ocrHighlightCard');
    const ocrView = document.getElementById('ocr-highlight-view');

    // ë°ì´í„°ê°€ ìˆë“  ì—†ë“  ì¼ë‹¨ ë°•ìŠ¤ê°€ ìˆëŠ”ì§€ í™•ì¸
    if (ocrCard && ocrView) {
        // ë°•ìŠ¤ ë³´ì´ê¸° (ê°•ì œ ì„¤ì •)
        ocrCard.style.display = 'block';

        if (data.design_ocr_text) {
            // í…ìŠ¤íŠ¸ ì±„ìš°ê¸°
            ocrView.innerHTML = renderHighlightText(data.design_ocr_text, data.issues);
        } else {
            ocrView.innerHTML = "OCR í…ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
        }
    } else {
        console.error("HTMLì— ocrHighlightCard ì•„ì´ë””ê°€ ì—†ìŠµë‹ˆë‹¤! ì˜¤íƒ€ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
    }


        if (!data.issues || data.issues.length === 0) {
            list.innerHTML = "<div class='alert alert-success'>ì™„ë²½í•©ë‹ˆë‹¤! ì˜¤ë¥˜ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>";
            return;
        }

        data.issues.forEach(item => {
            let cls = 'issue-minor';
            let badge = 'ì£¼ì˜';
            
            if (item.type === 'Critical') {
                cls = 'issue-critical';
                badge = 'ì¹˜ëª…ì ';
            } else if (item.type === 'Law_Violation') {
                cls = 'issue-law';
                badge = 'ë²•ë¥  ìœ„ë°˜';
            }

            let html = `
                <div class="${cls}">
                    <div class="fw-bold">[${badge}] ${item.location}</div>
                    <div class="my-1">${item.issue}</div>
                    <small class="text-muted">
                        ì •ë‹µ: ${item.expected} <br>
                        ì‹¤ì œ: ${item.actual}
            `;
            
            if (item.law_reference) {
                html += `<br>ê´€ë ¨ ë²•ë ¹: ${item.law_reference}`;
            }
            
            html += `</small></div>`;
            list.innerHTML += html;
        });

        window.scrollTo(0, document.body.scrollHeight);
    }
    // í…ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸ ì²˜ë¦¬ í•¨ìˆ˜
    function renderHighlightText(fullText, issues) {
        if (!fullText) return "ë¶„ì„ëœ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.";

        let html = fullText;
        issues.sort((a, b) => b.actual.length - a.actual.length);

        issues.forEach(issue => {
            if (issue.actual && html.includes(issue.actual)) {
                const highlightTag = `<span class="highlight-error" title="ì˜¤ë¥˜: ${issue.issue} (ì •ë‹µ: ${issue.expected})">${issue.actual}</span>`;
                html = html.split(issue.actual).join(highlightTag);
            }
        });
        return html;
    }

</script>

</body>
</html>
